<script setup lang="ts">
import { ref, inject, watch } from "vue"
import Data from "../data-web3"
import { Network } from "../../sdk/Network"
import { ethers, BigNumber } from "ethers"
import { Token, tokens } from "../classes/TokenManager"
import { YieldBox, TokenType, Asset } from "../classes/YieldBox"
import DeployedYieldBox from "../../deployments/localhost/YieldBox.json"
import USDAmount from "../components/USDAmount.vue"
import TokenAmount from "../components/TokenAmount.vue"
import { connectors } from "../../sdk/NetworkConnectors"
import { CoinGecko } from "../classes/CoinGeckoAPI"
import Web3Modal from "../components/Web3Modal.vue"
import TokenAmountInput from "../components/TokenAmountInput.vue"

const app = inject("app") as typeof Data
const tokenAddress = ref("")

const yieldBox = new YieldBox(Network.HARDHAT, DeployedYieldBox.address)

const load = async () => {
    await tokens.loadTokenList()

    console.log("Load assets")
    await yieldBox.loadAssets()

    console.log("Load balances")
    await app.account?.loadNetworkBalances(app.web3.chainId)
    console.log("Load yieldBox balances")
    await app.account?.loadYieldBoxBalances(yieldBox)

    console.log("Load prices")
    const connector = new connectors[app.web3.chainId]()
    await new CoinGecko().getPrices(connector, Object.values(tokens.tokens[connector.chainId]!))
}

load()
watch(
    () => app.web3.nonce,
    () => {
        console.log("Reloading")
        load()
    }
)

const depositToken = ref(null as Token | null)
const depositAmount = ref(null as BigNumber | null)

const addToken = async () => {
    tokens.get(app.web3.chainId, tokenAddress.value)
    tokens.loadInfo()
    load()
}

const deposit = async () => {
    if (depositToken.value && depositAmount.value) {
        const amount = depositAmount.value.eq(-1) ? app.account?.balance(depositToken.value) || 0 : depositAmount.value
        await app.web3.send(
            yieldBox.yieldBox
                .connect(app.web3.provider!.getSigner())
                .deposit(
                    TokenType.ERC20,
                    depositToken.value.address,
                    ethers.constants.AddressZero,
                    0,
                    app.web3.address,
                    app.web3.address,
                    amount,
                    0
                ),
            "Depositing " + depositToken.value.symbol + " into the YieldBox"
        )
    }
}

const withdrawAsset = ref(null as Asset | null)
const withdrawAmount = ref(null as BigNumber | null)

const withdraw = async () => {
    if (withdrawAsset.value && withdrawAmount.value) {
        if (withdrawAmount.value.eq(-1)) {
            const share = await yieldBox.yieldBox.balanceOf(app.web3.address, withdrawAsset.value.assetId)
            await app.web3.send(
                yieldBox.yieldBox
                    .connect(app.web3.provider!.getSigner())
                    .withdraw(withdrawAsset.value.assetId, app.web3.address, app.web3.address, 0, share),
                "Withdrawing all " + withdrawAsset.value.token?.symbol + " from the YieldBox"
            )
        } else {
            await app.web3.send(
                yieldBox.yieldBox
                    .connect(app.web3.provider!.getSigner())
                    .withdraw(withdrawAsset.value.assetId, app.web3.address, app.web3.address, withdrawAmount.value, 0),
                "Withdrawing " + withdrawAsset.value.token?.symbol + " from the YieldBox"
            )
        }
    }
}
</script>

<template>
    <div class="container-xl">
        <div class="row mt-3">
            <div class="col-12 col-md-6">
                <h3>Wallet</h3>
                <table class="table">
                    <thead>
                        <th>Token</th>
                        <th>Balance</th>
                        <th>Value</th>
                    </thead>
                    <tbody>
                        <tr v-for="token in app.account?.tokens">
                            <td>{{ token.symbol }}</td>
                            <td>
                                <TokenAmount :token="token" :amount="app.account?.balance(token)" />
                            </td>
                            <td>
                                <USDAmount :amount="app.account?.value(token)" />
                            </td>
                            <td class="text-end">
                                <b-button v-b-modal.modal-deposit @click="depositToken = token">Deposit</b-button>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <b-input-group>
                    <b-form-input v-model="tokenAddress" placeholder="Token Address"></b-form-input>
                    <b-button @click="addToken">Add</b-button>
                </b-input-group>
            </div>
            <div class="col-12 col-md-6">
                <h3>YieldBox</h3>
                <table class="table">
                    <thead>
                        <th>Token</th>
                        <th>Balance</th>
                        <th>Value</th>
                    </thead>
                    <tbody>
                        <tr v-for="asset in app.account?.assets">
                            <td>
                                <template v-if="asset.token">
                                    {{ asset.token.symbol }}
                                </template>
                            </td>
                            <td>
                                <TokenAmount :token="asset.token" :amount="app.account?.assetBalance(asset)" />
                            </td>
                            <td>
                                <USDAmount :amount="app.account?.assetValue(asset)" />
                            </td>
                            <td class="text-end">
                                <b-button v-b-modal.modal-withdraw @click="withdrawAsset = asset">Withdraw</b-button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <Web3Modal
            id="modal-deposit"
            :title="'Deposit ' + depositToken?.symbol"
            :token="depositToken"
            :spender="yieldBox.yieldBox.address"
            :amount="app.account?.balance(depositToken)"
            @click="deposit"
        >
            <label>Amount:</label>
            <TokenAmountInput v-model="depositAmount" :token="depositToken" :max="app.account?.balance(depositToken)"></TokenAmountInput>

            <label>Strategy:</label>
            <b-form-select></b-form-select>
        </Web3Modal>

        <Web3Modal id="modal-withdraw" @click="withdraw">
            <label>Amount:</label>
            <TokenAmountInput
                v-model="withdrawAmount"
                :token="withdrawAsset?.token"
                :max="app.account?.assetBalance(withdrawAsset)"
            ></TokenAmountInput>
        </Web3Modal>
    </div>
</template>

<style scoped></style>
